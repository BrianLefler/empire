<html>
	<head>
		<title>Hungry Empire</title>
		<link rel="shortcut icon" type="image/png" href="favicon.png"/>
		<script src="server.js"></script>
		<style>
			body {
				display: grid;
				margin: 0;
				font-family: sans-serif;
				background: url("images/empire_dawn.jpg");
				background-size: cover;
				background-position: center;
			}
			#login, #logged_in {
				padding: 0.2em;
				margin-left: auto;
				margin-right: auto;
			}
			#login {
				max-width: 23em;
			}
			#welcome {
				padding: 1em;
			}
			label {
				display: flex;
				width: 100%;
				justify-content: space-between;
			}
			#logged_in {
				display: none;
			}
			.flex {
				display: flex;
				flex-direction: row;
				justify-content: space-between;
			}
			#menu h1 {
				text-shadow: 0px 0px 4px #fff;
				font-family: serif;
			}
			h1, h2, h3 {
				margin: 0;
				text-align: center;
			}
			ul {
				list-style: none;
				padding-left: 0;
				margin-top: 0;
				margin-bottom: 0;
				padding-top: 0.3em;
				padding-bottom: 1em;
				display: flex;
				width: 100%;
				box-sizing: border-box;
				justify-content: space-around;
				flex-wrap: wrap;
				align-items: center;
			}
			a {
				transition: color 0.3s;	
				text-decoration: none;
			}
			a:hover {
				color: #a00;
			}
			#background {
				background-color: #fff;
				opacity: 0.8;
				z-index: -1;
			}
			@media (orientation: landscape) {
				body {
					grid-template-rows: min-content 1fr;
					grid-template-columns: 25% 50% 25%;
				}
				#background {
					grid-column: 1/4;
					grid-row: 2/4;
				}
				#banner {
					grid-row: 1;
					grid-column: 1;
				}
				#menu {
					grid-column: 1/4;
					grid-row: 2;
				}
				#banner {
					grid-column: 1/4;
					grid-row: 1;
				}
				#login {
					grid-column: 2;
					grid-row: 3;
				}
				#logged_in {
					grid-column: 1/3;
					grid-row: 3;
				}
				#welcome {
					grid-column: 1;
					grid-row: 3;
				}
				#stats {
					grid-column: 3;
					grid-row: 3;
				}
			}
			@media (orientation: portrait) {
				body {
					grid-template-rows: min-content min-content min-content min-content;
					grid-template-columns: 100%;
				}
				#banner {
					grid-row: 1;
					grid-column: 1;
				}
				#menu {
					grid-column: 1;
					grid-row: 2;
				}
				#welcome {
					grid-column: 1;
					grid-row: 3;
				}
				#login, #logged_in {
					grid-column: 1;
					grid-row: 4;
				}
				#stats {
					grid-column: 1;
					grid-row: 5;
				}
				#background {
					grid-column: 1;
					grid-row: 2/6;
				}
			}
		</style>
		<script>
			let whoami = "";
			let password = "";
		</script>
	</head>
	<body>
		<div id="background"></div>
		<ul id="menu">
			<li><h1>Hungry Empire</h1></li>
			<li><a href="https://groups.google.com/forum/#!forum/empire-playtesters">Forum</a></li>
			<li><a href="https://github.com/jpawlicki/empire/issues/new/choose">Report Bug</a></li>
			<li><a href="contribute.html">Contribute</a></li>
			<li><a href="privacy_policy.html">Privacy</a></li>
			<li><a href="contact.html">Contact</a></li>
		</ul>
		<div id="welcome">
			<p>Hungry Empire is a lightweight browser-based grand strategy game with asynchronous turn-based play. Each of the 26 players rules a nation and tries to achieve the goals they select. Game turns advance every few days, and players can set up their orders at any time between those advances.</p>
			<p>Whether the game is cooperative or competitive is up to the players. Players are trying to beat national high scores from past games.</p>
			<p>We don't run ads or microtransactions, and instead are supported by <a href="contribute.html">donations</a>.</p>
		</div>
		<div id="login">
			<h3>Log in to start or join a game lobby.</h3>
			<label>Email Address: <input type="email" id="email" placeholder="example@example.com"></input></label>
			<label>Password: <input type="password" id="password" placeholder="•••••••••"></input></label>
			<label>Remember me on this device: <input type="checkbox" id="login_rememberme"></input></label>
			<div class="flex">
				<button id="loginbutton">Log In</button>
				<button id="createaccountbutton">Create Account</button>
				<button id="resetbutton">Reset Password</button>
			</div>
			<div id="login_outcome"></div>
			<script>
				function enterPassword(noisyFailure = true, newAccount = false) {
					// Attempt to log in.
					document.getElementById("loginbutton").disabled = true;
					document.getElementById("createaccountbutton").disabled = true;
					document.getElementById("resetbutton").disabled = true;
					// Get lobby data.
					let req = new XMLHttpRequest();
					whoami = document.getElementById("email").value;
					password = document.getElementById("password").value;
					req.open("get", g_server + "/entry/index?k=" + window.encodeURIComponent(whoami) + "&password=" + window.encodeURIComponent(password) + (newAccount ? "&newaccount=t" : ""), true);
					req.onerror = function (e) {
						document.getElementById("login_outcome").innerHTML = "Error logging in: " + e;
						document.getElementById("createaccountbutton").disabled = false;
						document.getElementById("loginbutton").disabled = false;
						document.getElementById("resetbutton").disabled = false;
					};
					req.onload = function (ev) {
						if (req.status != 200) {
							if (noisyFailure) {
								if (req.status == 403) {
									document.getElementById("password").value = "";
									if (newAccount) document.getElementById("login_outcome").innerHTML = "An account with that e-mail address exists.";
									else document.getElementById("login_outcome").innerHTML = "Incorrect account / password.";
									try {
										localStorage.clear();
									} catch (e) {
										console.log(e);
									}
								} else {
									document.getElementById("login_outcome").innerHTML = "Error logging in: HTTP " + req.status;
								}
								document.getElementById("createaccountbutton").disabled = false;
								document.getElementById("loginbutton").disabled = false;
								document.getElementById("resetbutton").disabled = false;
							}
						} else {
							document.getElementById("login").style.display = "none";
							document.getElementById("welcome").style.display = "none";
							document.getElementById("loggedin_whoami").appendChild(document.createTextNode(whoami));
							document.getElementById("logged_in").style.display = "block";
							let d = JSON.parse(req.response);
							// TODO Do something with the response data.
							// If remember-me is checked, write login data to disk.
							if (document.getElementById("login_rememberme").checked) {
								try {
									localStorage.setItem("login", JSON.stringify({"email": whoami, "password": password}));
								} catch (e) {
									console.log("Will not save login data to local disk: " + e);
								}
							}
						}
					};
					req.send();
				}
				function newAccount() {
					enterPassword(true, true);					
				}
				function resetPassword() {
					document.getElementById("loginbutton").disabled = true;
					document.getElementById("createaccountbutton").disabled = true;
					document.getElementById("resetbutton").disabled = true;
					// TODO Trigger password reset flow: send nonce to client.
				}
				document.getElementById("loginbutton").addEventListener("click", enterPassword);
				document.getElementById("createaccountbutton").addEventListener("click", newAccount);
				document.getElementById("resetbutton").addEventListener("click", resetPassword);
				try {
					let login = localStorage.getItem("login");
					if (login != null) {
						document.getElementById("email").value = JSON.parse(login).email;
						document.getElementById("password").value = JSON.parse(login).password;
						enterPassword(false);
					}
				} catch (e) {
					console.log("Will not load login data from local disk: " + e);
				}
			</script>
		</div>
		<div id="logged_in">
			<div>Logged in as <span id="loggedin_whoami"></span> <button>Log Out</button> <button>Change Password</button></div>
			<div id="active_games">
				<h3>Games You are Playing</h3>
				<table><tr></tr></table>
			</div>
			<div id="lobbies">
				<h3>Lobbies Looking for Players</h3>
				<table>
					<tr>
						<th># Players Needed</th>
						<th>Capacity</th>
						<th>Deadline</th>
						<th>Pace</th>
					</tr>
				</table>
				<h3>Make New Lobby</h3>
				<div>
					<form onsubmit="return postFormStartLobby();">
						<label>Turns Advance: <select required>
							<option>Daily</option>
							<option>Daily (Weekdays Only)</option>
							<option>Monday &amp; Wednesday &amp; Friday</option>
							<option>Tuesday &amp; Friday</option>
							<option>Every 5 minutes</option>
						</select></label>
						<label>Days Of Week: <select id="newlobby_daysOfWeek" multiple required>
							<option>MONDAY</option>
							<option>TUESDAY</option>
							<option>WEDNESDAY</option>
							<option>THURSDAY</option>
							<option>FRIDAY</option>
							<option>SATURDAY</option>
							<option>SUNDAY</option>
						</select></label>
						<label>Time(s) (America/Los_Angeles): <select id="newlobby_times" multiple required></select></label>
						<label>Starting no later than (Local Time): <input id="newlobby_startAt" type="datetime-local" value="" required/></label>
						<button id="newlobby">Create Lobby</button>
						<div id="newlobby_outcome"></div>
					</form>
					<script>
						for (let i = 0; i < 60 / 5 * 24; i++) {
							let o = document.createElement("option");
							o.setAttribute("value", i * 5);
							o.appendChild(document.createTextNode(Math.floor(i * 5 / 60).toString().padStart(2, "0") + ":" + ((i * 5) % 60).toString().padStart(2, "0")));
							document.getElementById("newlobby_times").appendChild(o);
						}
						function postFormStartLobby() {
							document.getElementById()
							let req = new XMLHttpRequest();
							req.open("post", g_server + "/entry/startlobby", true);
							req.onerror = function (e) {
								document.getElementById("newlobby_outcome").innerHTML = "Lobby creation failed.";
							};
							req.onload = function (ev) {
								enterPassword(false);
							};
							let players = 26;
							req.send(JSON.stringify({
								"players": players,
								"schedule": {
									"times": Array.from(document.getElementById("newlobby_times").selectedOptions).map(e => parseInt(e.value)),
									"days": Array.from(document.getElementById("newlobby_daysOfWeek").selectedOptions).map(e => e.value),
									"locale": "America/Los_Angeles"
								},
								"min_players": Math.ceil(players / 2),
								"start_at_millis": new Date(document.getElementById("newlobby_startAt").value).getTime(),
							}));
							return false;
						}
					</script>
				</div>
			</div>
		</div>
		<div id="stats">
			<div id="active_games"># Active Games</div>
			<div id="top_scores">Top Scores This Quarter</div>
			<div id="score_data">Score Percentile Breakdown (Flame Chart?)</div>
		</div>
	</body>
</html>
