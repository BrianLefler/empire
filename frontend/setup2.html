<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Empire Setup</title>
		<script src="gamelib.js"></script>
		<script src="borders.js"></script>
		<script src="geolib.js"></script>
		<script src="report-link.js"></script>
		<script src="kingdom-report.js"></script>
		<script src="region-report.js"></script>
		<script src="character-report.js"></script>
		<script src="army-report.js"></script>
		<script src="church-report.js"></script>
		<script src="pirate-report.js"></script>
		<script src="gothi-report.js"></script>
		<script src="expandable-snippet.js"></script>
		<script src="tooltip-element.js"></script>
		<script src="formToJson.js"></script>
		<script src="orders-pane.js"></script>
		<script src="zip-div.js"></script>
		<script src="names.js"></script>
		<script src="server.js"></script>
		<script src="portrait-chooser.js"></script>
		<script src="defaultnations.js"></script>
		<script src="taggingdata.js"></script>
		<script>
			var gameId = 0;
			let g_geo = undefined;
			function regionClick() {
			}
			var taken = {};
			var chosenNation = "";
			var chosenConfig = {};
			window.onload = function() {
				if (g_player == null || g_password == null) {
					window.alert("Could not load your login state. Redirecting to home page to log in.");
					window.location.replace(window.location.href.replace("setup.html", "index.html"));
				}
				let t = window.location.search;
				let s = t.indexOf("g=");
				if (s == -1) window.alert("The link you received to this page should have included a g= query parameter. Contact Josh (gilgarn@gmail.com).");
				let e = t.indexOf("&", s);
				if (e == -1) e = t.length;
				gameId = parseInt(t.substring(s + 2, e));

				let req = new XMLHttpRequest();
				req.open("get", g_server + "/entry/setup?gid=" + gameId, true);
				addAuth(req, g_player, g_password);
				req.onerror = function (e) { window.alert("Error - check network connectivity: " + JSON.stringify(e)); };
				req.onload = function (ev) {
					if (req.status != 200) {
						window.alert(req.status + " error - check g= parameter in URL.");
						return;
					}
					let resp = JSON.parse(req.response);
					g_geo = resp.geography;
					start(resp);
					for (let k of resp.taken_nations) {
						document.querySelector("img[name=" + k.toLowerCase() + "]").className = "taken";
						for (let r of document.querySelectorAll("path." + k.toLowerCase())) {
							r.setAttribute("class", r.getAttribute("class") + " taken");
						}
						if (resp.chosen != k) taken[k.toLowerCase()] = true;
					}
					if (resp.hasOwnProperty("chosen")) {
						chosenNation = resp.chosen;
						chosenConfig = resp.chosen_config;
						let override = nations[chosenNation.toLowerCase()];
						override.traits[0] = chosenConfig.trait1;
						override.traits[1] = chosenConfig.trait2;
						override.ruler_name = chosenConfig.ruler_name;
						override.title = chosenConfig.title;
						override.bonus = chosenConfig.bonus;
						override.religion = chosenConfig.dominant_ideology;
						override.score = [];
						for (let s of ["prosperity", "happiness", "territory", "glory", "religion", "ideology", "security", "riches", "culture"]) if (chosenConfig[s] == "checked") override.score.push(s);
						document.querySelector("img[name=" + chosenNation.toLowerCase() + "]").classList.add("mine");
						for (let r of document.querySelectorAll("path." + chosenNation.toLowerCase())) {
							r.setAttribute("class", r.getAttribute("class") + " mine");
						}
					}
				};
				req.send();
				document.getElementById("nationDiv").appendChild(document.createElement("portrait-chooser"));
			}

			function start(numPlayers) {
				// Styleize
				let style = "";
				for (let k of g_geo.kingdoms) {
					style += "#svg.v_"  + k.name.toLowerCase() + " path." + k.name.toLowerCase() + "{ fill: #aaa; stroke: transparent; }\n";
				}
				document.getElementById("computed_styles").innerHTML = style;

				// Geoize
				geoize(false);
				let cores = {};
				for (let k of g_geo.kingdoms) cores[k.name] = [];
				{
					let kingdoms = [];
					for (let r of g_geo.regions) {
						if (r.core != -1 && r.core != undefined) {
							cores[g_geo.kingdoms[r.core].name].push(r.id);
						}
					}
				}
				var images = {};
				let cultures = {};
				for (let k of g_geo.kingdoms) {
					if (!cultures.hasOwnProperty(k.culture)) cultures[k.culture] = [];
					cultures[k.culture].push(k);
				}
				for (let culture in cultures) {
					let d = document.createElement("div");
					let h1 = document.createElement("h1");
					h1.appendChild(document.createTextNode(capitalize(culture)));
					d.appendChild(h1);
					document.getElementById("icons").appendChild(d);
					let icondiv = document.createElement("div");
					d.appendChild(icondiv);
					for (let k of cultures[culture]) {
						let img = document.createElement("img");
						img.setAttribute("name", k.name.toLowerCase());
						img.setAttribute("src", "images/heraldry/" + k.name.toLowerCase() + ".png");
						img.setAttribute("class", "icon");
						icondiv.appendChild(img);
						images[k.name] = new Image();
						images[k.name].src = "images/" + k.name.toLowerCase() + "_hd.jpg";
						for (let i of cores[k.name]) {
							document.getElementById("region_" + i).setAttribute("class", k.name.toLowerCase());
						}
					}
				}
				for (let i of document.querySelectorAll(".icon")) {
					i.addEventListener("mouseover", function() {
						document.getElementById("svg").setAttribute("class", "v_" + i.getAttribute("name"));
					});
					i.addEventListener("mouseout", function() {
						document.getElementById("svg").setAttribute("class", "");
					});
					i.addEventListener("click", function() {
						selectNation(i.getAttribute("name"), true);
					});
				}
			};
		</script>
    <style id="computed_styles"></style>
    <style>
			html, body {
				height: 100%;
				width: 100%;
				max-height: 100%;
				background: #000;
				padding: 0;
				margin: 0;
				font-family: sans-serif;
			}
			#body {
				display: flex;
				height: 100%;
				justify-content: space-between;
			}
      svg {
				height: 100%;
				max-width: 100%;
      }
			#regions path {
				fill: #333;
				transition: fill 1s;
			}
			#regions path.taken {
				fill: #222;
			}
			#regions path.mine {
				fill: #fc0;
			}
			#icons {
				display: flex;
				justify-content: space-between;
				flex-wrap: wrap;
				flex-basis: 10em;
				flex-grow: 1;
				max-height: 100%;
				overflow: auto;
			}
			#icons > div {
				max-height: 50%;
				display: flex;
				flex-direction: column;
				align-items: center;
				color: #fff;
				margin: 1em;
			}
			#icons > div > div {
				display: grid;
				grid-template-columns: 1fr 1fr;
				grid-template-rows: 1fr;
			}
			.icon {
				display: block;
				max-height: 8vh;
				max-width: 8vw;
				filter: grayscale(100%) invert(75%) drop-shadow(0 0 5px #000) drop-shadow(0 0 4px #000) drop-shadow(0 0 3px #000);
				cursor: pointer;
				transition: filter 0.5s, opacity 0.5s;
			}
			.icon:hover {
				filter: grayscale(100%) invert(100%) drop-shadow(0 0 5px #000) drop-shadow(0 0 4px #000) drop-shadow(0 0 3px #000);
			}
			.icon.mine {
				filter: invert(71%) sepia(94%) saturate(796%) hue-rotate(357deg) brightness(102%) contrast(107%);
			}
			.icon.taken {
				filter: grayscale(100%) drop-shadow(0 0 5px #888);
			}
			.icon.taken:hover {
				filter: grayscale(100%) drop-shadow(0 0 5px #fff);
			}
			#description {
				max-width: 40em;
				text-align: left;
				margin: auto;
			}
			#map {
				flex-basis: 100vh;
				overflow: hidden;
			}
			#nationDiv {
				position: absolute;
				top: 0;
				left: 0;
				z-index: 1;
				width: 100%;
				height: 100%;
				opacity: 0;
				visibility: hidden;
				background-color: #000;
				transition: opacity 2s;
				text-align: center;
				color: #fff;
				display: flex;
				flex-direction: column;
				min-height: 100%;
			}
			#background {
				position: fixed;
				top: 0;
				left: 0;
				bottom: 0;
				right: 0;
				width: 100%;
				z-index: -1;
				opacity: 0;
				transition: opacity 1s;
			}
			#banner {
				display: flex;
				width: min-content;
				align-items: center;
				background: rgba(0, 0, 0, 1);
				border-bottom-right-radius: 2em;
			}
			#banner > h1 {
				margin-top: 0;
				margin-bottom: 0;
				margin-left: 0.2em;
				margin-right: 1.5em;
			}
			#banner > span, #banner > button {
				margin-left: 1.5em;
				margin-right: 1.5em;
			}
			#banner > span {
				cursor: pointer;
			}
			#banner > span:hover {
				text-decoration: underline;
			}
			#banner > span.active {
				cursor: default;
				font-weight: bold;
				text-decoration: underline;
			}
			#tabs {
				display: flex;
				justify-content: space-around;
				flex-direction: column;
				align-items: center;
				flex-grow: 1;
				font-size: 120%;
			}
			.tabcontent {
				display: none;
			}
			label, button {
				display: block;
			}
			#name button {
				display: inline-block;
			}
			h2 {
				margin: 0;
				font-size: 120%;
			}
			#warning {
				font-weight: bold;
				color: #f00;
			}
			#confirmation {
				display: none;
				position: absolute;
				top: 40%;
				width: 100%;
				margin: auto;
				z-index: 1;
				text-shadow: 1px 1px 3px #fff, -1px 1px 3px #fff, 1px -1px 3px #fff, -1px -1px 3px #fff;
				font-size: 120%;
			}
			#nationDiv > div.selectionDone {
				pointer-events: none;
				opacity: 0;
			}

			#traits > div {
				display: flex;
				justify-content: space-around;
				flex-direction: row;
			}

			#traits > div > div {
				flex-basis: 15em;
				flex-shrink: 1;
				text-align: left;
			}

			#traits h2 {
				text-align: center;
				margin-bottom: 0.5em;
			}

			#traits select {
				color: #fff;
				background-color: #000;
				border: 1px solid #aaa;
				border-radius: 1em;
				font-size: 125%;
				width: 100%;
				margin-bottom: 0.5em;
				padding-left: 0.25em;
				padding-right: 0.25em;
			}
			
			#values > div {
				display: flex;
				flex-direction: column;
			}

			#values > div > label {
				margin: 0.5em;
				padding: 0.5em;
				display: flex;
				flex-direction: row;
				align-items: center;
				background-color: #000;
				border-radius: 5em;
				border: 1px solid #444;
			}

			#values ul {
				margin: 0;
			}

			#values li {
				text-align: left;
			}

			#values input {
				margin-right: 1em;
			}

			#values h2 {
				width: 6em;
				text-align: left;
			}

			#characters > div {
				display: flex;
				flex-direction: row;
				flex-wrap: wrap;
			}

			#characters > div > div {
				display: flex;
				flex-direction: column;
				width: 10em;
				height: 20em;
				margin-left: 0.5em;
				margin-right: 0.5em;
				justify-content: flex-end;
				align-items: center;
				background: #000;
				border-top-left-radius: 1em;
				border-top-right-radius: 1em;
				border: 1px solid #aaa;
			}

			#characters span {
				background: #000;
			}

			#characters span, #characters input {
				width: 100%;
				text-align: center;
			}

			#characters button {
				width: 80%;
			}

			#characters select, #characters input {
				margin-top: 1em;
			}

			portrait-chooser {
				display: none;
				position: absolute;
				width: 80vw;
				height: 80vh;
				margin-top: 10vh;
				margin-left: 10vw;
				margin-right: 10vw;
				z-index: 3;
			}

			#regionstab input {
				color: #fff;
				background: #000;
				border: 1px solid white;
				border-radius: 2em;
				font-size: 120%;
				margin: 0.5em;
				padding: 0.5em;
			}
    </style>
  </head>
  <body>
		<div id="body">
			<div id="icons"></div>
			<div id="map">
				<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000" id="svg" version="1.1">
					<!-- Patterns -->
					<g id="content">
						<g id="regions" class="v_political">
						</g>
						<g id="sea_regions">
						</g>
						<g id="borders">
						</g>
						<g id="regionContents">
						</g>
					</g>
				</svg>
			</div>
		</div>
		<div id="nationDiv">
			<div id="background"></div>
			<div id="banner">
				<img id="selectedheraldry" class="icon" name=""/>
				<h1 id="nationName"></h1>
				<span id="tab_menu_about">About</span>
				<span id="tab_menu_traits">Traits</span>
				<span id="tab_menu_values">Values</span>
				<span id="tab_menu_characters">Characters</span>
				<span id="tab_menu_regionstab">Regions</span>
				<button id="submit">Confirm Selection</button>
			</div>
			<div id="tabs">
				<div id="about" class="tabcontent">
					<div id="description">Default description.</div>
					<input id="nationNameInput" type="hidden" name="name"></input>
				</div>
				<div id="traits" class="tabcontent">
					<div>
						<div>
							<h2>Trait</h2>
							<select name="trait1" id="trait1"></select>
							<div id="trait1_consequences"></div>
						</div>
						<div>
							<h2>Trait</h2>
							<select name="trait2" id="trait2"></select>
							<div id="trait2_consequences"></div>
						</div>
						<div>
							<h2>Religion</h2>
							<select id="dominant_ideology" name="dominant_ideology"></select>
							<div id="ideology_consequences"></div>
						</div>
						<div>
							<h2>Bonus</h2>
							<select name="bonus" id="bonus">
								<option value="armies">Armies</option>
								<option value="navies">Navies</option>
								<option value="gold">Gold</option>
								<option value="food">Food</option>
							</select>
							<div id="bonus_consequences"></div>
						</div>
					</div>
				</div>
				<div id="values" class="tabcontent">
					<div>
						<label>
							<input type="checkbox" name="prosperity"/>
							<h2>Prosperity</h2>
							<ul>
								<li>Gain points for feeding people.</li>
								<li>Gain points for leftover food.</li>
								<li>Lose points for starvation in your regions.</li>
							</ul>
						</label>
						<label>
							<input type="checkbox" name="happiness"/>
							<h2>Happiness</h2>
							<ul>
								<li>Gain points for having low unrest.</li>
								<li>Lose points for having high unrest.</li>
							</ul>
						</label>
						<label>
							<input type="checkbox" name="territory"/>
							<h2>Territory</h2>
							<ul>
								<li>Gain points for gaining territory.</li>
								<li>Lose points for losing territory.</li>
							</ul>
						</label>
						<label>
							<input type="checkbox" name="glory"/>
							<h2>Glory</h2>
							<ul>
								<li>Gain points for fighting in large battles.</li>
								<li>Lose points for not fighting.</li>
							</ul>
						</label>
						<label>
							<input type="checkbox" name="religion"/>
							<h2>Religion</h2>
							<ul>
								<li>Gain points for converting regions to your religion.</li>
								<li>Lose points when regions are converted away from your religion.</li>
							</ul>
						</label>
						<label>
							<input type="checkbox" name="ideology"/>
							<h2>Ideology</h2>
							<ul>
								<li>Gain points for converting regions to your ideology.</li>
								<li>Lose points when regions are converted away from your ideology.</li>
							</ul>
						</label>
						<label>
							<input type="checkbox" name="security"/>
							<h2>Security</h2>
							<ul>
								<li>Gain points for keeping enemy and neutral forces away from your regions.</li>
								<li>Lose points when enemy or neutral forces are near your regions.</li>
							</ul>
						</label>
						<label>
							<input type="checkbox" name="riches"/>
							<h2>Riches</h2>
							<ul>
								<li>Gain points for treasuring up lots of gold.</li>
								<li>Lose points for having little gold available.</li>
							</ul>
						</label>
						<label>
							<input type="checkbox" name="culture"/>
							<h2>Culture</h2>
							<ul>
								<li>Gain points when people of your culture are happier than others.</li>
								<li>Lose points when people of your culture are unhappier than others.</li>
							</ul>
						</label>
					</div>
				</div>
				<div id="characters" class="tabcontent">
					<div>
						<div id="char1">
							<input type="hidden" id="char1_portrait" name="char1_portrait" value=""/>
							<span id="c1_type">Ruler</span>
							<select name="title" id="title">
								<option>Chief</option>
								<option>Chieftain</option>
								<option>Chieftess</option>
								<option>Commander</option>
								<option>Doge</option>
								<option>Dogaressa</option>
								<option>Emir</option>
								<option>Emira</option>
								<option>Jarl</option>
								<option>Judge</option>
								<option>Justice</option>
								<option>Khan</option>
								<option>King</option>
								<option>Lady</option>
								<option>Lord</option>
								<option>Marshall</option>
								<option>Master</option>
								<option>Miss</option>
								<option>Mister</option>
								<option>Mistress</option>
								<option>Prime Minister</option>
								<option>Prince</option>
								<option>Princess</option>
								<option>Queen</option>
								<option>Sultan</option>
								<option>Sultana</option>
								<option>Warlady</option>
								<option>Warlord</option>
							</select>
							<input type="text" name="cname1" id="cname1" placeholder="Type name or use button.">
							<button onclick="nameClick(1, 'm');">Masculine Name</button><button onclick="nameClick(1, 'f');">Feminine Name</button><button onclick="nameClick(1, 'mf');">Ungendered Name</button>
							<button onclick="changePortrait(1);">Choose Portrait</button>
							<select name="ability_1" id="ability_1">
								<option>Admiral</option>
								<option>General</option>
								<option>Governor</option>
								<option>Spy</option>
							</select>
						</div>
						<div id="char2">
							<input type="hidden" id="char2_portrait" name="char2_portrait" value=""/>
							<input type="text" name="cname2" id="cname2" placeholder="Type name or use button.">
							<button onclick="nameClick(2, 'm');">Masculine Name</button><button onclick="nameClick(2, 'f');">Feminine Name</button><button onclick="nameClick(2, 'mf');">Ungendered Name</button>
							<button onclick="changePortrait(2);">Choose Portrait</button>
							<select name="ability_2" id="ability_2">
								<option>Admiral</option>
								<option>General</option>
								<option>Governor</option>
								<option>Spy</option>
							</select>
						</div>
						<div id="char3">
							<input type="hidden" id="char3_portrait" name="char3_portrait" value=""/>
							<input type="text" name="cname3" id="cname3" placeholder="Type name or use button.">
							<button onclick="nameClick(3, 'm');">Masculine Name</button><button onclick="nameClick(3, 'f');">Feminine Name</button><button onclick="nameClick(3, 'mf');">Ungendered Name</button>
							<button onclick="changePortrait(3);">Choose Portrait</button>
							<select name="ability_3" id="ability_3">
								<option>Admiral</option>
								<option>General</option>
								<option>Governor</option>
								<option>Spy</option>
							</select>
						</div>
						<div id="char4">
							<input type="hidden" id="char4_portrait" name="char4_portrait" value=""/>
							<input type="text" name="cname4" id="cname4" placeholder="Type name or use button.">
							<button onclick="nameClick(4, 'm');">Masculine Name</button><button onclick="nameClick(4, 'f');">Feminine Name</button><button onclick="nameClick(4, 'mf');">Ungendered Name</button>
							<button onclick="changePortrait(4);">Choose Portrait</button>
							<select name="ability_4" id="ability_4">
								<option>Admiral</option>
								<option>General</option>
								<option>Governor</option>
								<option>Spy</option>
							</select>
						</div>
						<div id="char5">
							<input type="hidden" id="char5_portrait" name="char5_portrait" value=""/>
							<span id="c5_type"></span>
							<input type="text" name="cname5" id="cname5" placeholder="Type name or use button.">
							<button onclick="nameClick(5, 'm');">Masculine Name</button><button onclick="nameClick(5, 'f');">Feminine Name</button><button onclick="nameClick(5, 'mf');">Ungendered Name</button>
							<button onclick="changePortrait(5);">Choose Portrait</button>
							<select name="ability_5" id="ability_5">
								<option>Admiral</option>
								<option>General</option>
								<option>Governor</option>
								<option>Spy</option>
							</select>
						</div>
						<div id="char6">
							<input type="hidden" id="char6_portrait" name="char6_portrait" value=""/>
							<span id="c6_type"></span>
							<input type="text" name="cname6" id="cname6" placeholder="Type name or use button.">
							<button onclick="nameClick(6, 'm');">Masculine Name</button><button onclick="nameClick(6, 'f');">Feminine Name</button><button onclick="nameClick(6, 'mf');">Ungendered Name</button>
							<button onclick="changePortrait(6);">Choose Portrait</button>
							<select name="ability_6" id="ability_6">
								<option>Admiral</option>
								<option>General</option>
								<option>Governor</option>
								<option>Spy</option>
							</select>
						</div>
						<div id="char7">
							<input type="hidden" id="char7_portrait" name="char7_portrait" value=""/>
							<span id="c7_type"></span>
							<input type="text" name="cname7" id="cname7" placeholder="Type name or use button.">
							<button onclick="nameClick(7, 'm');">Masculine Name</button><button onclick="nameClick(7, 'f');">Feminine Name</button><button onclick="nameClick(7, 'mf');">Ungendered Name</button>
							<button onclick="changePortrait(7);">Choose Portrait</button>
							<select name="ability_7" id="ability_7">
								<option>Admiral</option>
								<option>General</option>
								<option>Governor</option>
								<option>Spy</option>
							</select>
						</div>
						<div id="char8">
							<input type="hidden" id="char8_portrait" name="char8_portrait" value=""/>
							<span id="c8_type"></span>
							<input type="text" name="cname8" id="cname8" placeholder="Type name or use button.">
							<button onclick="nameClick(8, 'm');">Masculine Name</button><button onclick="nameClick(8, 'f');">Feminine Name</button><button onclick="nameClick(8, 'mf');">Ungendered Name</button>
							<button onclick="changePortrait(8);">Choose Portrait</button>
							<select name="ability_8" id="ability_8">
								<option>Admiral</option>
								<option>General</option>
								<option>Governor</option>
								<option>Spy</option>
							</select>
						</div>
					</div>
				</div>
				<div id="regionstab" class="tabcontent">
					<h2>Region Names</h2>
					<input type="text" id="region1" name="region1"></input>
					<input type="text" id="region2" name="region2"></input>
					<input type="text" id="region3" name="region3"></input>
					<input type="text" id="region4" name="region4"></input>
					<input type="text" id="region5" name="region5"></input>
					<input type="text" id="region6" name="region6"></input>
					<input type="text" id="region7" name="region7"></input>
					<input type="text" id="region8" name="region8"></input>
					<input type="text" id="region9" name="region9"></input>
				</div>
				<div id="warning"></div>
			</div>
			<section id="confirmation"><h1>You rule <span id="nationnameconfirm"></span></h1>Your selection has been confirmed and you will be e-mailed when all other players are ready.</section>
		</div>
		<script>
			function showTab(tab) {
				for (let t of document.querySelectorAll(".tabcontent")) t.style.display = "none";
				for (let t of document.querySelectorAll("#banner > span")) t.className = "";
				if (tab != "") {
					document.getElementById(tab).style.display = "block";
					document.getElementById("tab_menu_" + tab).className = "active";
					document.getElementById("background").style.opacity = 0.2;
				}
			}
			for (let t of ["about", "traits", "values", "characters", "regionstab"]) document.getElementById("tab_menu_" + t).addEventListener("click", () => showTab(t));

			let selected = "";
			let legalIdeologies = {
				"anpilayn": ["Iruhan (Chalice of Compassion)", "Iruhan (Sword of Truth)", "Iruhan (Tapestry of People)", "Iruhan (Vessel of Faith)"],
				"eolsung": ["Northern (Alyrja)", "Northern (Lyskr)", "Northern (Rjinku)", "Northern (Syrjen)"],
				"hansa": ["Iruhan (Chalice of Compassion)", "Iruhan (Sword of Truth)", "Iruhan (Tapestry of People)", "Iruhan (Vessel of Faith)", "Northern (Alyrja)", "Northern (Lyskr)", "Northern (Rjinku)", "Northern (Syrjen)"],
				"tavian": ["Tavian (Flame of Kith)", "Tavian (River of Kuun)"],
				"tyrgaetan": ["Northern (Alyrja)", "Northern (Lyskr)", "Northern (Rjinku)", "Northern (Syrjen)"]
			}
			let cultureDescriptions = {
				"anpilayn": "Anpilayn culture is broadly characterized by high literacy, technological advancement, cultural achievement, prosperity, and wealth, but also by sexism, religious intolerance, and a stratified society. Anpilayn soldiers are mostly well-equipped and well-trained professionals skilled at large battles.",
				"eolsung": "Eolsung culture is broadly characterized by societal mobility, individualism, magic, and personal freedom, but also by violence, poor literacy, and poverty. Eolsung armies are mostly raiders who excel at hit-and-run tactics and occupation of enemy territory.",
				"hansa": "Hansa culture is broadly characterized by tolerance, wealth, trade, and strong local communities, but also by greed, lack of ethics, and ruthlessness. Hansa armies are mostly sailors and slaves who excel at combat on the high seas and converting captives to their cause.",
				"tavian": "Tavian culture is broadly characterized by collectivism, craftsmanship, and lawfulness, but also by a rigid caste system, rampant slavery, and decadence. Tavian armies are mostly riders and artisans, who excel both at moving swiftly in difficult terrain and at coexisting with local communities.",
				"tyrgaetan": "Tyrgaetan culture is broadly characterized by mysticism, nomadism, and strong family groups, but also by poor literacy, technological backwardness, and sparse population. Tyrgaetan armies are mostly clan or family units, who excel at crossing friendly terrain quickly and operating even in the harshest climates.",
			};
			let ideologyDescriptions = {
				"Iruhan (Chalice of Compassion)": "Your people broadly believe that all life is precious. They are ecological and produce more food during harvests, but also produce less tax.",
				"Iruhan (Sword of Truth)": "Your people broadly believe that other religions are dangerous. They produce both more numerous and higher quality soldiers.",
				"Iruhan (Tapestry of People)": "Your people broadly believe that all points of view are valuable. They engage in greater economic activity when bordering regions with different cultures, religions, or ideologies, and their soldiers become more effective as you develop diverse ideologies within your own borders.",
				"Iruhan (Vessel of Faith)": "Your people broadly believe that God (Iruhan) has a personal relationship with them. They are generally happier and reject the authority of the Church of Iruhan, making you largely immune to the effects of a negative relationship with the Church. Building temples makes them very happy, and their missionaries can build temples in any nation.",
				"Northern (Alyrja)": "Your people broadly believe in constant vigilence. They destroy all pirates in your territory and give you reports on all hidden units within or adjacent to your regions. Additionally, they do not object to the use of limited rations, so long as there is no starvation.",
				"Northern (Lyskr)": "Your people broadly believe in the power of knowledge and secrets. Your plotting and intrigue will be far more effective.",
				"Northern (Rjinku)": "Your people broadly believe in the glory of war. Your nation generates significantly more soldiers and your generals become far more effective.",
				"Northern (Syrjen)": "Your people broadly believe in economic cooperation. Your nation produces more economic income, both on land and sea.",
				"Tavian (Flame of Kith)": "Your people broadly believe that the duty of the fortunate is to provide for the unfortunate. Your people attract more immigrants and your governors are more effective.",
				"Tavian (River of Kuun)": "Your people broadly believe that trade and prosperity are tightly linked. Using plentiful rations benefits your economy and any tribute relationships you have generate extra gold.",
			};
			let traitConsequences = {
				"Aristocratic": "You start with nobles in every core region, and your nobles gain experience more quickly.",
				"Defensive": "You start with fortifications in each of your regions, and your people are twice as effective at constructing new fortifications.",
				"Disciplined": "Your armies are more effective, and your regions are easier to patrol.",
				"Evangelical": "Your people will fund the spreading of your state religion.",
				"Heroic": "You control extra heroic characters.",
				"Holy": "While your state ideology matches the dominant Iruhan ideology, the Church of Iruhan will donate about twice as much gold to you.",
				"Imperialistic": "Nations that pay you tribute receive benefits, and you receive extra benefits from each nation paying you tribute.",
				"Industrial": "All construction in your nation is inexpensive.",
				"Mercantile": "Your nation starts with more gold and produces more tax.",
				"Mystical": "Construction of temples are discounted and reduce popular unrest when built.",
				"Patriotic": "Your nation starts with more soldiers and produces more recruits.",
				"Rebellious": "All but one of the regions of your regions start controlled by your neighbors. You start with extra gold and armies. Your navies and armies within your rightful borders cost less to maintain.",
				"Republican": "Your nation is a republic, not a kingdom. Popular unrest decreases in every one of your regions over time, but you cannot use feudal nobles.",
				"Seafaring": "You start with extra warships and gain more gold from sea regions than other nations do.",
				"Ship-Building": "Whenever you construct a new shipyard, it immediately produces an extra small fleet of warships.",
				"Sneaky": "You start with bonus spy rings and your spies are better at sabotaging plots.",
				"Stoic": "High unrest never decreases the size of the harvest in your regions, and your regions are more difficult for enemies to conquer.",
				"War-like": "You start with extra soldiers and your rightful regions produce more taxation and recruits per region you've conquered that rightfully belongs to another nation.",
				"Welcoming": "Your regions are twice as attractive to immigrants.",
			};
			let bonusConsequences = {
				"armies": "You start with +50% armies. This will help you acquire and defend territory in the early weeks, but will place greater demands on your economy.",
				"navies": "You start with +50% navies. This will help you project power overseas in the early weeks, but will place greater demands on your economy.",
				"gold": "You start with +100% gold. This will help you with construction in the early weeks.",
				"food": "You start with +50% food. This will help you avoid starvation in the early weeks, but other nations may seek to take your food from you.",
			};

			for (let trait in traitConsequences) {
				for (let i of [1, 2]) {
					let o = document.createElement("option");
					o.innerHTML = trait;
					document.getElementById("trait" + i).appendChild(o);;
				}
			}

			function formChange() {
				let warnings = [];
				let trait1 = document.getElementById("trait1").value;
				let trait2 = document.getElementById("trait2").value;
				let di = document.getElementById("dominant_ideology").value;
				document.getElementById("trait1_consequences").innerHTML = traitConsequences[trait1];
				document.getElementById("trait2_consequences").innerHTML = traitConsequences[trait2];
				document.getElementById("ideology_consequences").innerHTML = ideologyDescriptions[di];
				document.getElementById("bonus_consequences").innerHTML = bonusConsequences[document.getElementById("bonus").value];
				if (trait1 == trait2) warnings.push("You cannot select the same trait twice.");
				if (document.getElementById("cname1").value == "") warnings.push("You must generate a ruler name.");
				if (document.getElementById("title").value == "Prime Minister" && !(trait1 == "Republican" || trait2 == "Republican")) warnings.push("To avoid confusion, only leaders of republics may be called Prime Minister.");
				if ((trait1 == "Republican" || trait2 == "Republican") && (trait1 == "Aristocratic" || trait2 == "Aristocratic")) warnings.push("Aristocratic republics are not allowed.");
				if ((trait1 == "Holy" || trait2 == "Holy") && !di.includes("Iruhan")) warnings.push("Only nations with an Iruhan dominant religion can choose the Holy trait.");
				document.getElementById("submit").disabled = warnings.length > 0;
				if (chosenNation != "") warnings.push("This will replace your current nation selection.");
				document.getElementById("warning").innerHTML = warnings.join(" ");

				// Show / Hide character panels.
				let count = 5;
				if (di.startsWith("Iruhan") && di != "Iruhan (Vessel of Faith)") {
					document.getElementById("c" + count + "_type").innerHTML = "Cardinal";
					document.getElementById("char" + count).style.display = "flex";
					count++;
				}
				if (trait1 == "Heroic" || trait2 == "Heroic") {
					document.getElementById("c" + count + "_type").innerHTML = "";
					document.getElementById("char" + count).style.display = "flex";
					count++;
					document.getElementById("c" + count + "_type").innerHTML = "";
					document.getElementById("char" + count).style.display = "flex";
					count++;
				}
				if (trait1 == "Republican" || trait2 == "Republican") {
					document.getElementById("c" + count + "_type").innerHTML = "";
					document.getElementById("char" + count).style.display = "flex";
					count++;
				}
				for (; count < 9; count++) {
					document.getElementById("char" + count).style.display = "none";
				}
			}
			for (let f of document.querySelectorAll("input, select")) f.addEventListener("input", formChange);
			
			function selectNation(nation, push) {
				showTab("");
				let d = document.getElementById("nationDiv");
				if (selected != "" || nation == "") {
					if (push) history.pushState({"nation": ""}, "Empire Setup");
					document.title = "Empire Setup";
					d.style.opacity = 0;
					d.style.visibility = "hidden";
					selected = "";
				} else {
					if (push) history.pushState({"nation": nation}, "Empire Setup: " + capitalize(nation));
					document.title = "Empire Setup: " + capitalize(nation);
					selected = nation;
					document.getElementById("selectedheraldry").setAttribute("src", "images/heraldry/" + nation + ".png");
					d.style.visibility = "visible";
					d.style.opacity = 1;
					let bg = document.getElementById("background");
					bg.style.background = "url(images/" + nation + "_hd.jpg) center center/cover";
					bg.style.opacity = 1;
					document.getElementById("nationName").innerHTML = capitalize(nation);
					document.getElementById("description").innerHTML = (taken[nation] ? "<p>A player has already claimed this nation.</p>" : "") + nations[nation].description + "<p>" + cultureDescriptions[nations[nation].culture] + "</p>";
					if (!taken[nation]) for (let s of document.querySelectorAll("input, button, select")) if (s.getAttribute("id") != "submit") s.disabled = false;
					document.getElementById("nationNameInput").value = capitalize(selected);
					document.getElementById("trait1").value = nations[nation].traits[0];
					document.getElementById("trait2").value = nations[nation].traits[1];
					document.getElementById("title").value = nations[nation].title;
					document.getElementById("bonus").value = nations[nation].bonus;
					for (let i = 1; i < 9; i++) {
						let c = nations[nation].characters[i - 1];
						document.getElementById("cname" + i).value = c.name;
						document.getElementById("char" + i + "_portrait").value = c.portrait;
						document.getElementById("char" + i).style.background = "no-repeat url(images/portraits/" + c.portrait + ".png) top / 100%, #000";
						document.getElementById("ability_" + i).value = c.skill;
					}
					document.getElementById("dominant_ideology").innerHTML = "";
					for (let r of nations[nation].hasOwnProperty("legalIdeologiesOverride") ? nations[nation].legalIdeologiesOverride : legalIdeologies[nations[nation].culture]) {
						let o = document.createElement("option");
						o.innerHTML = r;
						document.getElementById("dominant_ideology").appendChild(o);
						if (r.includes(nations[nation].religion)) document.getElementById("dominant_ideology").value = r;
					}
					for (let s of document.querySelectorAll("input[type=checkbox]")) s.checked = false;
					for (let s of nations[nation].score) {
						document.getElementsByName(s)[0].checked = true;
					}
					for (let s of document.querySelectorAll("input")) s.style.display = "inline-block";
					if (nations[nation].hasOwnProperty("regions")) {
						let i = 1;
						for (; i <= nations[nation].regions.length; i++) {
							document.getElementById("region" + i).value = nations[nation].regions[i - 1];
							document.getElementById("region" + i).style.display = "block";
						}
						for (; i <= 9; i++) document.getElementById("region" + i).style.display = "none";
					} else {
						let core = -1;
						for (let i = 0; i < g_geo.kingdoms.length; i++) if (g_geo.kingdoms[i].name.toLowerCase() == nation) core = i;
						let i = 1;
						for (let r of g_geo.regions) if (r.core == core) {
							document.getElementById("region" + i).value = r.name;
							document.getElementById("region" + i).style.display = "block";
							i++;
						}
						for (; i <= 9; i++) document.getElementById("region" + i).style.display = "none";
					}
					formChange();
				}
			}

			function nameClick(i, t) {
				document.getElementById("cname" + i).value = generateName(nations[selected].culture, t);
				formChange();
			}

			let changingPortrait = null;
			function changePortrait(i) {
				changingPortrait = i;
				document.querySelector("portrait-chooser").style.display = "flex";
			}

			function selectPortrait(index) {
				if (index != null) {
					console.log(index);
					document.getElementById("char" + changingPortrait).style.background = "no-repeat url(images/portraits/" + index + ".png) top / 100%, #000";
					document.getElementById("char" + changingPortrait + "_portrait").value = index;
				}
				changingPortrait = null;
				document.querySelector("portrait-chooser").style.display = "none";
			}

			let submit = document.getElementById("submit");
			submit.addEventListener("click", function() {
				taken[selected] = true;
				document.querySelector("img[name=" + selected + "]").classList.add("taken");

				for (let s of document.querySelectorAll("form input, form button, form select")) s.disabled = true;
				submit.innerHTML = "Checking with server...";
				let req = new XMLHttpRequest();
				req.open("post", g_server + "/entry/setup?gid=" + gameId, true);
				addAuth(req, g_player, g_password);
				req.onerror = function (e) {
					submit.innerHTML = "A different player has already claimed this nation";
				};
				req.onload = function (ev) {
					if (req.status == 400) {
						submit.innerHTML = "A different player has already claimed this nation";
					} else if (req.status == 204) {
						document.querySelector("#nationnameconfirm").innerHTML = capitalize(selected);
						document.querySelector("#nationDiv > div").className = "selectionDone";
						document.querySelector("#confirmation").style.display = "block";
						for (let e of document.querySelectorAll("img")) e.style.display = "none";
					} else {
						window.alert("HTTP " + req.status + ". Contact Josh (gilgarn@gmail.com)");
					}
				};
				req.send(formToJson("form"));
			});

			window.addEventListener("popstate", (event) => selectNation(event.state.nation, false));
			history.replaceState({"nation": ""}, "Empire Setup", "");
		</script>
	</body>
</html>
