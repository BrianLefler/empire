<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Empire Setup</title>
		<script src="gamelib.js"></script>
		<script src="borders.js"></script>
		<script src="geolib.js"></script>
		<script src="report-link.js"></script>
		<script src="kingdom-report.js"></script>
		<script src="region-report.js"></script>
		<script src="character-report.js"></script>
		<script src="army-report.js"></script>
		<script src="church-report.js"></script>
		<script src="pirate-report.js"></script>
		<script src="gothi-report.js"></script>
		<script src="expandable-snippet.js"></script>
		<script src="tooltip-element.js"></script>
		<script src="formToJson.js"></script>
		<script src="orders-pane.js"></script>
		<script src="zip-div.js"></script>
		<script src="names.js"></script>
		<script src="server.js"></script>
		<script src="defaultnations.js"></script>
		<script>
			var gameId = 0;
			let g_geo = undefined;
			function regionClick() {
			}
			var taken = {};
			var chosenNation = "";
			var chosenConfig = {};
			window.onload = function() {
				if (g_player == null || g_password == null) {
					window.alert("Could not load your login state. Redirecting to home page to log in.");
					window.location.replace(window.location.href.replace("setup.html", "index.html"));
				}
				let t = window.location.search;
				let s = t.indexOf("g=");
				if (s == -1) window.alert("The link you received to this page should have included a g= query parameter. Contact Josh (gilgarn@gmail.com).");
				let e = t.indexOf("&", s);
				if (e == -1) e = t.length;
				gameId = parseInt(t.substring(s + 2, e));

				let req = new XMLHttpRequest();
				req.open("get", g_server + "/entry/setup?gid=" + gameId, true);
				addAuth(req, g_player, g_password);
				req.onerror = function (e) { window.alert("Error - check network connectivity: " + JSON.stringify(e)); };
				req.onload = function (ev) {
					if (req.status != 200) {
						window.alert(req.status + " error - check g= parameter in URL.");
						return;
					}
					let resp = JSON.parse(req.response);
					g_geo = resp.geography;
					start(resp);
					for (let k of resp.taken_nations) {
						document.querySelector("img[name=" + k.toLowerCase() + "]").className = "taken";
						for (let r of document.querySelectorAll("path." + k.toLowerCase())) {
							r.setAttribute("class", r.getAttribute("class") + " taken");
						}
						if (resp.chosen != k) taken[k.toLowerCase()] = true;
					}
					if (resp.hasOwnProperty("chosen")) {
						chosenNation = resp.chosen;
						chosenConfig = resp.chosen_config;
						let override = nations[chosenNation.toLowerCase()];
						override.traits[0] = chosenConfig.trait1;
						override.traits[1] = chosenConfig.trait2;
						override.ruler_name = chosenConfig.ruler_name;
						override.title = chosenConfig.title;
						override.bonus = chosenConfig.bonus;
						override.religion = chosenConfig.dominant_ideology;
						override.score = [];
						for (let s of ["prosperity", "happiness", "territory", "glory", "religion", "ideology", "security", "riches", "culture"]) if (chosenConfig[s] == "checked") override.score.push(s);
						document.querySelector("img[name=" + chosenNation.toLowerCase() + "]").className = "mine";
						for (let r of document.querySelectorAll("path." + chosenNation.toLowerCase())) {
							r.setAttribute("class", r.getAttribute("class") + " mine");
						}
					}
				};
				req.send();
			}

			function start(numPlayers) {
				// Styleize
				let style = "";
				for (let k of g_geo.kingdoms) {
					style += "#svg.v_"  + k.name.toLowerCase() + " path." + k.name.toLowerCase() + "{ fill: #aaa; stroke: transparent; }\n";
				}
				document.getElementById("computed_styles").innerHTML = style;

				// Geoize
				geoize(false);
				let cores = {};
				for (let k of g_geo.kingdoms) cores[k.name] = [];
				{
					let kingdoms = [];
					for (let r of g_geo.regions) {
						if (r.core != -1 && r.core != undefined) {
							cores[g_geo.kingdoms[r.core].name].push(r.id);
						}
					}
				}
				var images = {};
				let count = 0;
				for (let k of g_geo.kingdoms) {
					let p = document.getElementById(count >= g_geo.kingdoms.length / 2 ? "icons2" : "icons1");
					let img = document.createElement("img");
					img.setAttribute("name", k.name.toLowerCase());
					img.setAttribute("src", "images/heraldry/" + k.name.toLowerCase() + ".png");
					p.appendChild(img);
					images[k.name] = new Image();
					images[k.name].src = "images/" + k.name.toLowerCase() + "_hd.jpg";
					for (let i of cores[k.name]) {
						document.getElementById("region_" + i).setAttribute("class", k.name.toLowerCase());
					}
					count++;
				}
				for (let i of document.getElementsByTagName("img")) {
					i.addEventListener("mouseover", function() {
						document.getElementById("svg").setAttribute("class", "v_" + i.getAttribute("name"));
					});
					i.addEventListener("mouseout", function() {
						document.getElementById("svg").setAttribute("class", "");
					});
					i.addEventListener("click", function() {
						selectNation(i.getAttribute("name"));
					});
				}
			};
		</script>
    <style id="computed_styles"></style>
    <style>
			html, body {
				height: 100%;
				width: 100%;
				max-height: 100%;
				background: #000;
				padding: 0;
				margin: 0;
			}
			#body {
				display: grid;
				grid-template-rows: 100%;
				grid-template-columns: 20% 60% 20%;
				height: 100%;
			}
			#body > div {
				max-width: 100%;
				max-height: 100%;
				overflow: auto;
			}
      text {
        font-family: 'Niconne', cursive;
      
			}
      svg {
				height: 100%;
				max-width: 100%;
      }
			#regions path {
				fill: #333;
				transition: fill 1s;
			}
			#regions path.taken {
				fill: #222;
			}
			#regions path.mine {
				fill: #fc0;
			}
			#body > .icons {
				display: flex;
				flex-direction: column;
				justify-content: space-between;
				align-items: center;
				align-content: space-around;
				flex-wrap: wrap;
			}
			.icons img {
				display: block;
				max-height: 14%;
				max-width: 50%;
				filter: grayscale(100%) invert(75%) drop-shadow(0 0 5px #000) drop-shadow(0 0 4px #000) drop-shadow(0 0 3px #000);
				cursor: pointer;
				transition: filter 0.5s, opacity 0.5s;
				z-index: 2;
				position: relative;
			}
			.icons img:hover {
				filter: grayscale(100%) invert(100%) drop-shadow(0 0 5px #000) drop-shadow(0 0 4px #000) drop-shadow(0 0 3px #000);
			}
			.icons img.taken {
				filter: grayscale(100%) drop-shadow(0 0 5px #888);
			}
			.icons img.mine {
				filter: invert(71%) sepia(94%) saturate(796%) hue-rotate(357deg) brightness(102%) contrast(107%);
			}
			.icons img.taken:hover {
				filter: grayscale(100%) drop-shadow(0 0 5px #fff);
			}
			#nationDiv {
				position: absolute;
				top: 0;
				left: 0;
				z-index: 1;
				width: 100%;
				height: 100%;
				opacity: 0;
				background: #fff;
				visibility: hidden;
				transition: opacity 2s;
				text-align: center;
			}
			#nationDiv > div {
				width: 60%;
				height: 100%;
				overflow: auto;
				background: rgba(255, 255, 255, 0.7);
				display: inline-block;
				padding: 1em;
				text-align: left;
				box-sizing: border-box;
				box-shadow: 0 0 10px #fff;
			}
			#nationDiv > div > h1 {
				text-transform: capitalize;
				font-family: sans-serif;
				text-align: center;
			}
			form {
			}
			label, button {
				display: block;
			}
			#name button {
				display: inline-block;
			}
			h2 {
				margin-bottom: 0;
				font-family: sans-serif;
				font-size: 120%;
			}
			#warning {
				font-weight: bold;
				color: #800;
			}
			input[type=text], input[type=password] {
				width: 20em;
			}
			#confirmation {
				display: none;
				position: absolute;
				top: 40%;
				width: 100%;
				margin: auto;
				z-index: 1;
				text-shadow: 1px 1px 3px #fff, -1px 1px 3px #fff, 1px -1px 3px #fff, -1px -1px 3px #fff;
				font-family: sans-serif;
				font-size: 120%;
			}
			#nationDiv > div.selectionDone {
				pointer-events: none;
				opacity: 0;
			}
    </style>
  </head>
  <body>
		<div id="body">
			<div id="icons1" class="icons">
			</div>
			<div id="map">
				<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000" id="svg" version="1.1">
					<!-- Patterns -->
					<g id="content">
						<g id="regions" class="v_political">
						</g>
						<g id="sea_regions">
						</g>
						<g id="borders">
						</g>
						<g id="regionContents">
						</g>
					</g>
				</svg>
			</div>
			<div id="icons2" class="icons">
			</div>
		</div>
		<div id="nationDiv">
			<div>
				<h1 id="nationName"></h1>
				<div id="description">Default description.</div>
				<form id="form" action="javascript:void(0);">
					<input id="nationNameInput" type="hidden" name="name"></input>
					<h2>Ruler</h2>
					<div id="name">You are:
						<select name="title" id="title">
							<option>Chieftain</option>
							<option>Chieftess</option>
							<option>Emir</option>
							<option>Emira</option>
							<option>Jarl</option>
							<option>Khan</option>
							<option>King</option>
							<option>Lady</option>
							<option>Lord</option>
							<option>Prime Minister</option>
							<option>Prince</option>
							<option>Princess</option>
							<option>Queen</option>
							<option>Sultan</option>
							<option>Sultana</option>
							<option>Warlady</option>
							<option>Warlord</option>
						</select>
						<input type="text" name="ruler_name" id="ruler_name" placeholder="Press button to generate." disabled></label><button id="newname_male" type="button">Masculine Name</button><button id="newname_female" type="button">Feminine Name</button><button id="newname_unisex" type="button">Ungendered Name</button>
						<div><tooltip-element tooltip="Your selections here determine how you are scored at the end of the game. You can select any number, and you will receive points for doing well in that dimension, but will lose points for doing poorly. You are also free to ignore the score and role-play your character as you wish - in this case these choices will inform other rulers of your reputation.">You care deeply about:</tooltip-element>
							<label><input type="checkbox" name="prosperity"/>Feeding your people. (Recommended)</label>
							<label><input type="checkbox" name="happiness"/>The happiness of your people.</label>
							<label><input type="checkbox" name="territory"/>Expanding your nation's borders.</label>
							<label><input type="checkbox" name="glory"/>Fighting in glorious combat.</label>
							<label><input type="checkbox" name="religion"/>Converting heathens to your religion.</label>
							<label><input type="checkbox" name="ideology"/>Converting heathens and heretics to your religion.</label>
							<label><input type="checkbox" name="security"/>Keeping enemies away from your people.</label>
							<label><input type="checkbox" name="riches"/>Amassing wealth.</label>
							<label><input type="checkbox" name="culture"/>The happiness of all people of your culture.</label>
						</div>
					</div>
					<h2>People</h2>
					Your people are known to be:
					<select name="trait1" id="trait1"></select>,
					<select name="trait2" id="trait2"></select>,
					and primarily followers of the <select id="dominant_ideology" name="dominant_ideology"></select> religion.
					<div id="trait_consequences"></div>
					<h2>Bonus</h2>
					Your nation starts with a double share of the world's <select name="bonus" id="bonus">
						<option>armies</option>
						<option>navies</option>
						<option>gold</option>
						<option>food</option>
					</select>, due to your preparation in recent years.
					<button id="submit">Confirm Selection</button>
					<div id="warning"></div>
				</form>
			</div>
			<section id="confirmation"><h1>You rule <span id="nationnameconfirm"></span></h1>Your selection has been confirmed and you will be e-mailed when all other players are ready.</section>
		</div>
		<script>
			let selected = "";
			let legalIdeologies = {
				"anpilayn": ["Iruhan (Chalice of Compassion)", "Iruhan (Sword of Truth)", "Iruhan (Tapestry of People)", "Iruhan (Vessel of Faith)"],
				"eolsung": ["Northern (Alyrja)", "Northern (Lyskr)", "Northern (Rjinku)", "Northern (Syrjen)"],
				"hansa": ["Iruhan (Chalice of Compassion)", "Iruhan (Sword of Truth)", "Iruhan (Tapestry of People)", "Iruhan (Vessel of Faith)", "Northern (Alyrja)", "Northern (Lyskr)", "Northern (Rjinku)", "Northern (Syrjen)"],
				"tavian": ["Tavian (Flame of Kith)", "Tavian (River of Kuun)"],
				"tyrgaetan": ["Northern (Alyrja)", "Northern (Lyskr)", "Northern (Rjinku)", "Northern (Syrjen)"]
			}
			let cultureDescriptions = {
				"anpilayn": "Anpilayn culture is broadly characterized by high literacy, technological advancement, cultural achievement, prosperity, and wealth, but also by sexism, religious intolerance, and a stratified society. Anpilayn soldiers are mostly well-equipped and well-trained professionals skilled at large battles.",
				"eolsung": "Eolsung culture is broadly characterized by societal mobility, individualism, magic, and personal freedom, but also by violence, poor literacy, and poverty. Eolsung armies are mostly raiders who excel at hit-and-run tactics and occupation of enemy territory.",
				"hansa": "Hansa culture is broadly characterized by tolerance, wealth, trade, and strong local communities, but also by greed, lack of ethics, and ruthlessness. Hansa armies are mostly sailors and slaves who excel at combat on the high seas and converting captives to their cause.",
				"tavian": "Tavian culture is broadly characterized by collectivism, craftsmanship, and lawfulness, but also by a rigid caste system, rampant slavery, and decadence. Tavian armies are mostly riders and artisans, who excel both at moving swiftly in difficult terrain and at coexisting with local communities.",
				"tyrgaetan": "Tyrgaetan culture is broadly characterized by mysticism, nomadism, and strong family groups, but also by poor literacy, technological backwardness, and sparse population. Tyrgaetan armies are mostly clan or family units, who excel at crossing friendly terrain quickly and operating even in the harshest climates.",
			};
			let ideologyDescriptions = {
				"Iruhan (Chalice of Compassion)": "Your people broadly believe that all life is precious. They are ecological and produce more food during harvests, but also produce less tax.",
				"Iruhan (Sword of Truth)": "Your people broadly believe that other religions are dangerous. They produce both more numerous and higher quality soldiers.",
				"Iruhan (Tapestry of People)": "Your people broadly believe that all points of view are valuable. They engage in greater economic activity when bordering regions with different cultures, religions, or ideologies, and their soldiers become more effective as you develop diverse ideologies within your own borders.",
				"Iruhan (Vessel of Faith)": "Your people broadly believe that God (Iruhan) has a personal relationship with them. They are generally happier and reject the authority of the Church of Iruhan, making you largely immune to the effects of a negative relationship with the Church. Building temples makes them very happy, and their missionaries can build temples in any nation.",
				"Northern (Alyrja)": "Your people broadly believe in constant vigilence. They destroy all pirates in your territory and give you reports on all hidden units within or adjacent to your regions. Additionally, they do not object to the use of limited rations, so long as there is no starvation.",
				"Northern (Lyskr)": "Your people broadly believe in the power of knowledge and secrets. Your plotting and intrigue will be far more effective.",
				"Northern (Rjinku)": "Your people broadly believe in the glory of war. Your nation generates significantly more soldiers and your generals become far more effective.",
				"Northern (Syrjen)": "Your people broadly believe in economic cooperation. Your nation produces more economic income, both on land and sea.",
				"Tavian (Flame of Kith)": "Your people broadly believe that the duty of the fortunate is to provide for the unfortunate. Your people attract more immigrants and your governors are more effective.",
				"Tavian (River of Kuun)": "Your people broadly believe that trade and prosperity are tightly linked. Using plentiful rations benefits your economy and any tribute relationships you have generate extra gold.",
			};
			let traitConsequences = {
				"Aristocratic": "You start with nobles in every core region, and your nobles gain experience more quickly.",
				"Defensive": "You start with fortifications in each of your regions, and your people are twice as effective at constructing new fortifications.",
				"Disciplined": "Your armies are more effective, and your regions are easier to patrol.",
				"Evangelical": "Your people will fund the spreading of your state religion.",
				"Heroic": "You control extra heroic characters.",
				"Holy": "While your state ideology matches the dominant Iruhan ideology, the Church of Iruhan will donate about twice as much gold to you.",
				"Imperialistic": "Nations that pay you tribute receive benefits, and you receive extra benefits from each nation paying you tribute.",
				"Industrial": "All construction in your nation is inexpensive.",
				"Mercantile": "Your nation starts with more gold and produces more tax.",
				"Mystical": "Construction of temples are discounted and reduce popular unrest when built.",
				"Patriotic": "Your nation starts with more soldiers and produces more recruits.",
				"Rebellious": "All but one of the regions of your regions start controlled by your neighbors. You start with extra gold and armies. Your navies and armies within your rightful borders cost less to maintain.",
				"Republican": "Your nation is a republic, not a kingdom. Popular unrest decreases in every one of your regions over time, but you cannot use feudal nobles.",
				"Seafaring": "You start with extra warships and gain more gold from sea regions than other nations do.",
				"Ship-Building": "Whenever you construct a new shipyard, it immediately produces an extra small fleet of warships.",
				"Sneaky": "You start with bonus spy rings and your spies are better at sabotaging plots.",
				"Stoic": "High unrest never decreases the size of the harvest in your regions, and your regions are more difficult for enemies to conquer.",
				"War-like": "You start with extra soldiers and your rightful regions produce more taxation and recruits per region you've conquered that rightfully belongs to another nation.",
				"Welcoming": "Your regions are twice as attractive to immigrants.",
			};
			for (let trait in traitConsequences) {
				for (let i of [1, 2]) {
					let o = document.createElement("option");
					o.innerHTML = trait;
					document.getElementById("trait" + i).appendChild(o);;
				}
			}
			document.getElementById("form").addEventListener("input", function() {
				let warnings = [];
				let trait1 = document.getElementById("trait1").value;
				let trait2 = document.getElementById("trait2").value;
				let di = document.getElementById("dominant_ideology").value;
				document.getElementById("trait_consequences").innerHTML = "<p>" + traitConsequences[trait1] + "</p><p>" + traitConsequences[trait2] + "</p><p>" + ideologyDescriptions[document.getElementById("dominant_ideology").value] + "</p>";
				if (trait1 == trait2) warnings.push("You cannot select the same trait twice.");
				if (document.getElementById("ruler_name").value == "") warnings.push("You must generate a ruler name.");
				if (document.getElementById("title").value == "Prime Minister" && !(trait1 == "Republican" || trait2 == "Republican")) warnings.push("To avoid confusion, only leaders of republics may be called Prime Minister.");
				if ((trait1 == "Republican" || trait2 == "Republican") && (trait1 == "Aristocratic" || trait2 == "Aristocratic")) warnings.push("Aristocratic republics are not allowed.");
				if ((trait1 == "Holy" || trait2 == "Holy") && !di.includes("Iruhan")) warnings.push("Only nations with an Iruhan dominant religion can choose the Holy trait.");
				document.getElementById("submit").disabled = warnings.length > 0;
				if (chosenNation != "") warnings.push("This will replace your current nation selection.");
				document.getElementById("warning").innerHTML = warnings.join(" ");
			});
			
			function selectNation(nation) {
				let d = document.getElementById("nationDiv");
				if (selected != "") {
					for (let i of document.getElementsByTagName("img")) {
						i.style.opacity = 1;
						i.style.pointerEvents = "inherit";
					}
					d.style.opacity = 0;
					d.style.visibility = "hidden";
					selected = "";
				} else {
					selected = nation;
					for (let i of document.getElementsByTagName("img")) {
						if (i.getAttribute("name") == nation) continue;
						i.style.opacity = 0;
						i.style.pointerEvents = "none";
					}
					d.style.visibility = "visible";
					d.style.background = "url(images/" + nation + "_hd.jpg) center/cover";
					d.style.opacity = 1;
					document.getElementById("nationName").innerHTML = nation;
					document.getElementById("description").innerHTML = (taken[nation] ? "<p>A player has already claimed this nation.</p>" : "") + nations[nation].description + "<p>" + cultureDescriptions[nations[nation].culture] + "</p>";
					if (!taken[nation]) for (let s of document.querySelectorAll("form input, form button, form select")) if (s.getAttribute("id") != "submit") s.disabled = false;
					document.getElementById("nationNameInput").value = capitalize(selected);
					document.getElementById("trait1").value = nations[nation].traits[0];
					document.getElementById("trait2").value = nations[nation].traits[1];
					document.getElementById("title").value = nations[nation].title;
					document.getElementById("bonus").value = nations[nation].bonus;
					document.getElementById("ruler_name").value = nations[nation].hasOwnProperty("ruler_name") ? nations[nation].ruler_name : "";
					document.getElementById("dominant_ideology").innerHTML = "";
					document.getElementById("form").style.display = taken[nation] ? "none" : "block";
					for (let r of nations[nation].hasOwnProperty("legalIdeologiesOverride") ? nations[nation].legalIdeologiesOverride : legalIdeologies[nations[nation].culture]) {
						let o = document.createElement("option");
						o.innerHTML = r;
						document.getElementById("dominant_ideology").appendChild(o);
						if (r.includes(nations[nation].religion)) document.getElementById("dominant_ideology").value = r;
					}
					for (let s of document.querySelectorAll("input[type=checkbox]")) s.checked = false;
					for (let s of nations[nation].score) {
						document.getElementsByName(s)[0].checked = true;
					}
					form.dispatchEvent(new Event("input"));
					for (let s of document.querySelectorAll("input")) s.style.display = "inline-block";
				}
			}

			document.getElementById("newname_male").addEventListener("click", function() {
				document.getElementById("ruler_name").value = generateName(nations[selected].culture, "m");
				document.getElementById("form").dispatchEvent(new Event("input"));
			});
			document.getElementById("newname_female").addEventListener("click", function() {
				document.getElementById("ruler_name").value = generateName(nations[selected].culture, "f");
				document.getElementById("form").dispatchEvent(new Event("input"));
			});
			document.getElementById("newname_unisex").addEventListener("click", function() {
				document.getElementById("ruler_name").value = generateName(nations[selected].culture, "mf");
				document.getElementById("form").dispatchEvent(new Event("input"));
			});
			let submit = document.getElementById("submit");
			submit.addEventListener("click", function() {
				taken[selected] = true;
				document.querySelector("img[name=" + selected + "]").className = "taken";

				for (let s of document.querySelectorAll("form input, form button, form select")) s.disabled = true;
				submit.innerHTML = "Checking with server...";
				let req = new XMLHttpRequest();
				req.open("post", g_server + "/entry/setup?gid=" + gameId, true);
				addAuth(req, g_player, g_password);
				req.onerror = function (e) {
					submit.innerHTML = "A different player has already claimed this nation";
				};
				req.onload = function (ev) {
					if (req.status == 400) {
						submit.innerHTML = "A different player has already claimed this nation";
					} else if (req.status == 204) {
						document.querySelector("#nationnameconfirm").innerHTML = capitalize(selected);
						document.querySelector("#nationDiv > div").className = "selectionDone";
						document.querySelector("#confirmation").style.display = "block";
						for (let e of document.querySelectorAll("img")) e.style.display = "none";
					} else {
						window.alert("HTTP " + req.status + ". Contact Josh (gilgarn@gmail.com)");
					}
				};
				req.send(formToJson("form"));
			});
		</script>
	</body>
</html>
