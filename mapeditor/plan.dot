// Implementation Plan
/*

Upcoming Rules Changes:
 * Armies no longer consume any food.
   * This is to workaround an issue where players could figure out the size of hidden armies by carefully tallying the food consumption in each region.
	 * Army food consumption was also inconsistent between sea and land regions and caused confusion in regions with tiny populations (because the UI did not predict/communicate how much food would be eaten by the army, so people doing exact food transfers tended to under-guess by a couple thousand and have a hundred or so civilians starve to death.
 * Conquest of a region will require having an "Always attack their armies/navies" disposition toward the current ruler of that region.
   * This is to avoid a situation where you can pay tribute to a nation while simultaneously conquering their territories, or be "friendly" or "neutral" to a nation on the turn you backstab them.
	 * Consequently, the noble unrest penalty for conquering a region paying tribute to you has been lowered to 6, to keep the overall unrest cost of conquering a tributary's regions at 10.
 * Rulers of hidden captive characters will not be told who the captor is?
   * In practice they tend to have a small list of possible culprits, so this doesn't change too much.
 * The "Raiders" tag will no longer hide the army from the actual owner of the region the army occupies.
 * The "Policing" trait of nobles will now read "Pirates will not appear in this region. The noble contributes 8 gold each turn to bribe pirates not to appear in the nation overall." (It currently reads "Pirates will not appear in this region.")
   * Nobles reducing pirate probability in a specific region is a very small contribution to your national security overall, but the "banditry" crisis is very common due to how people tend to group up their armies. Making the effect more powerful will hopefully make it feel a little better when you successfully resolve a banditry crisis.
 * The "Pillagers (Pirate)" tag of pirate armies will now contribute +0.4 pirate threat per gold, rather than +1.
   * This and the following two changes are because pirates are snowballing more than I want in the g=2 game: A pirate army occupying a region that produces 24 tax is racking up 2400 more pirates per turn, but usually takes several turns to destroy - the g=2 game is currently at +8800 pirates spawning every turn and will probably be around 20k/turn or more by the time this change takes effect. I do like pirates snowballing a little bit to make the Northern (Alyrja) religion/ideology attractive but 20k pirates per turn is going to be a bit much, I think.
 * The "Unpredictable" ("Moves randomly, but not into sea regions.") tag of pirate armies will be replaced with "Unruly": "Divides into two equal armies each turn. Both armies move randomly, but not into sea regions.".
   * Having them automatically split up both makes it a little less swingy about where the deathball pirate army moves, creates a more widespread regional problem when a large amount of pirates show up, and weakens the pirates over time, so that if a nation can't deal with them right away, they can suffer through the income loss (and overall increased threat) for a while and then the problem will be more tractible. 
 * The sources of increase in pirate threat will be disclosed to all players. (Bribes about where the pirates appear are still secret.)
	 * I think right now people don't really understand why threat is increasing so much. This also facilitates better international cooperation in controlling pirate threat.
 * Adding a state-only ideology: "Company". This state ideology is used if and only if a government controls no regions at all. The effects are: "+50% plot strength. Your armies and navies cost half as much to maintain".
   * In both games there are players approaching 0 held regions, at which point their state ideology is undefined by the current rules. This keeps such players interesting, and provides a bit of a catch-up mechanic as well. It is also an opportunity for alliances of nations to specialize their members - if they can trust each other!
	 * I also imagine that this might unlock new play styles in future games, where players might start as companies and act entirely as mercenaries, with some option to spend money to hire soldiers out of the pirate pool or similar.
 * The minimum conquest size of a region formula has been adjusted slightly so that fortification, unrest, and other mods to the minimum conquest size now stack additively, which is more consistent with other modifiers in the game.
 * The minimum patrol size of a region now factors in regional unrest: happy regions are easier to patrol, solve banditry in, and oust nobles from; high-unrest regions are much harder.
 * The death of a ruler will no longer cause a player to lose a turn - the heir will be chosen immediately.

Long-Term Changes
 * Chalice of Compassion will cause -30% taxation income, rather than -30% recruitment.
		* The recruitment penalty means little to CoC-heavy nations - it doesn't affect their troop cap and can easily be overcome by the signing bonus mechanic. Changing CoC to affect overall economy makes it harder to play a CoC nation that is militarily secure, which encourages them to form better alliances rather than just turtle.
 * Signing bonus efficacy will be scaled down (cost twice as much for the same effect).
		* Overall I think signing bonus is earning too much.
 * 10% increase in the global amount of food.
    * I need a better way to create inequality of distribution, too. A lot of the score profiles (religion, culture, etc) are good conflict generators but in these games I feel they've been overshadoweded a bit too much by the food issues.

=======CRITICAL
interstitials
Check all TODOs.
game status report (GM mail, turn number)

=======PLANNED
Eliminate passwords - e-mails for game start and game advance include kingdom and one-turn-use passwords in the URL, which is scrubbed via javascript
E-mail GM on turn advance.
Build player waitlist database.


=======OPTIONAL
Merge-lines, divisions planned movement arrows.
Intrigue map overlay
Pirate threat map overlay
Kingdom report - trait tooltips
Character Portraits?
Kingdom customization: allow specifying a signature
culture map is questionable - use flag icon?
legend for map. Collapseable?

GAME DATA MODEL:

g_turndata = {
	"date": 2
	"regions": [
		{
			"population": 100000,
			"kingdom": "Fiskrbaer",
			"unrest_popular": 0.32,
			"noble": {
				"name": "Sir Iassac Newton",
				"tags": ["Inspiring"],
				"crisis": 
					"type": "recession",
					"deadline": 4,
					"goal": 244
				},
				unrest": "0.22"
			},
			"constructions": [
				{"type": "shipyard", "original_cost": 33},
				{"type": "temple", "religion": "Northern (Alyrja)", "original_cost": 33}
				{"type": "fortifications", "original_cost": 22},
			],
			"food": 765000,
			"harvest": 7.91,
		},
	],
	"kingdoms": {
		"Fiskrbaer": {
			"gold": 34.78,
			"relationships": {
				"Aefoss": {
					"battle": "only_in_territory",
					"refugees": "no",
					"defend": "defensive_wars_only",
					"tribute": .25,
					"construct": "yes",
				}
			},
			"gothi": {
				"Alyrja": false,
				"Syrjen": false,
				"Rjinku": true,
				"Lyskr": true,
			},
			"goodwill": -22,
			"loyal_to_cult": false,
			"court": [
				{"name": "Nobli Noblus", "tags": ["Inspiring"]},
			],
		}
	},
	"communications": [
		{
			"from": "Fiskrbaer",
			"signed": "Fiskrbaer", // Anonymous letters will say "Anonymous".
			"to": ["Aefoss"],
			"intercepted": ["Hosshofn"],
			"text": "Hallbjorn, you are so cool.",
			"post_date": 3,
		},
	],
	"characters": [
		{
			"name": "Dudeman Examplar",
			"kingdom": "Fiskrbaer",
			"captor": "Aefoss", // "" if free.
			"location": 123, // -1 if unknown.
			"preparation": [
				{"to": 124, "amount": 1},
			],
			"tags": ["Cardinal"],
			"experience": {
				"general": 22,
				"admiral": 22,
				"governor": 22,
				"spy": 22,
			},
			"order_hint": "Travel to Fireskattr"
		}
	],
	"armies": [ // Includes navies - doesn't include hidden forces.
		"id": id,
		"type": "army", // Or "navy"
		"kingdom": "Fiskrbaer",
		"size": 6050,
		"tags": ["Steel", "Formations"],
		"location": 123,
		"preparation": [
			{"to": 124, "amount": 1},
		],
		"orderhint": "Travel to Fireskattr"
	],
	"pirate": {
		"threat": 1234.5,
		"bribes": {
			"Fiskrbaer": 0,
			"Aefoss": 50,
			"Hosshofn": -50,
		},
	}
	"tivar": {
		"warwinds": false,
		"deluge": false,
		"parch": true,
		"veil": true,
	},
};

 */

digraph {
	color_adjustment
	faction_presets
	region_images
	kingdom_images
	region_seasonality -> region_report_ui
	basic_faction_selection -> map_populator
	basic_faction_selection -> adv_faction_selection
	server_data_store -> adv_faction_selection
	game_data_model -> map_populator
	game_data_model -> map_ui
	game_data_model -> orders_ui
	game_data_model -> region_report_ui
	game_data_model -> character_report_ui
	game_data_model -> army_report_ui
	game_data_model -> global_report_ui
	game_data_model -> communication_report_ui
	game_data_model -> kingdom_report_ui
	region_report_ui -> report_ui
	character_report_ui -> report_ui
	army_report_ui -> report_ui
	kingdom_report_ui -> report_ui
	global_report_ui -> report_ui
	communication_report_ui -> report_ui
	map_ui -> ui_integration
	orders_ui -> ui_integration
	rtc_ui -> ui_integration
	report_ui -> ui_integration
	ui_integration -> server_sync
	server_sync -> server_datastore
	server_sync -> server_endturn
	server_datastore -> server_endturn
	game_data_model -> turn_resolver
	server_datastore -> turn_resolver
	turn_resolver -> resolver_mailer
}
